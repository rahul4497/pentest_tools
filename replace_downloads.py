#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""TODO: To run properly, this script requires packets flowing through
    this machine to be trapped in a NFQUEUE via the iptables command or
    its Windows or MacOS equivalent. Currently, this needs to be done
    manually, but can also be implemented through a call to subprocess.
    Future implementation should build on the `with`-context manager to
    ensure orderly restoring of proper packet flow, i.e. flushing of
    iptables.
    ATTENTION: Please bear in mind, that depending on the source of the
    packets to be trapped, i.e. local or remote, the relevant chain that
    has to be specified in the iptables command are either the FORWARD-
    chain for foreign packets, or in the INPUT/OUTPUT-chain.
"""

import netfilterqueue
import scapy.all as scapy


def process_packet(packet):
    scapy_packet = scapy.IP(packet.get_payload())
    if scapy_packet.haslayer(scapy.DNSRR):
        # TODO: Section 8 Writing a File Interceptor - Video 69
        pass
    packet.accept()


queue = netfilterqueue.NetfilterQueue()
queue.bind(0, process_packet)
queue.run()
